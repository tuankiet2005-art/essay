<script>
// Thư viện marker dùng lại nhiều lần
// Dùng pattern IIFE để không làm bẩn global namespace
const LeafletMarkers = (() => {

    // 1. Các icon màu (dùng bộ leaflet-color-markers trên GitHub)
    const coloredIcons = {
        red: new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
        }),
        blue: new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
        }),
        green: new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
        }),
        orange: new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
        }),
        violet: new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-violet.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
            iconSize:     [25, 41],
            iconAnchor:   [12, 41],
            popupAnchor:  [1, -34],
            shadowSize:   [41, 41]
        })
        // cần thêm màu khác thì copy block trên là xong
    };

    // Hàm 1: marker màu (icon ghim)
   function addColoredMarker(map, lat, lng, color = 'red', popupData = null) {
    const icon = coloredIcons[color] || coloredIcons.red;
    const marker = L.marker([lat, lng], { icon }).addTo(map);

    if (popupData) {
        let popupContent = '';

        if (typeof popupData === 'string') {
            popupContent = popupData;
        } else {
            // Logic popup đã được chỉnh sửa để có giao diện hiện đại và hợp mắt hơn

            const imgSrc = popupData.image; 

            popupContent = `
                <div style="
                    min-width: 300px; /* Chiều rộng tối thiểu cho không gian hiển thị */
                    max-width: 400px;
                    padding: 0; 
                    box-sizing: border-box;
                    font-family: Arial, sans-serif;
                ">
                    ${imgSrc ? `
                    <div style="
                        background-color: #f0f0f0; /* Màu nền nhẹ cho khu vực ảnh */
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        height: 100px; /* Chiều cao cố định cho khu vực logo/ảnh */
                        overflow: hidden;
                        border-bottom: 1px solid #ddd;
                        /* Đảm bảo ảnh tràn viền trên cùng */
                        margin: -10px -14px -14px -10px; /* Tùy chỉnh này áp dụng cho Leaflet popup mặc định có padding 14px */
                    ">
                        <img src="${imgSrc}"
                            alt="${popupData.title || 'Image'}"
                            style="
                                max-width: 100%;
                                max-height: 100%;
                                object-fit: contain; /* Đảm bảo logo/ảnh hiển thị đầy đủ */
                                display: block;
                                padding: 10px;
                            ">
                    </div>
                    ` : ''}

                    <div style="padding: 10px 14px 10px 14px ;"> ${popupData.title ? `
                        <h3 style="
                            margin: 10px 0px 0px 0px ;
                            font-size: 18px;
                            color: #007bff; /* Màu sắc nổi bật cho tiêu đề */
                            border-bottom: 2px solid #007bff;
                            padding-bottom: 2px;
                        ">${popupData.title}</h3>
                        ` : ''}

                        ${popupData.summary ? `
                        <p style="
                            margin: 0px 0px 5px 0px;
                            font-size: 14px;
                            line-height: 1.6;
                            color: #333;
                            white-space: pre-line;
                            max-height: 150px; /* Giới hạn chiều cao cho đoạn tóm tắt */
                            overflow-y: auto; /* Thêm thanh cuộn nếu nội dung dài */
                        ">
                            ${popupData.summary}
                        </p>
                        ` : ''}

                        ${popupData.url ? `
                            <button style="
                                padding: 8px 15px;
                                cursor: pointer;
                                background-color: #007bff;
                                color: white;
                                border: none;
                                border-radius: 4px;
                                font-size: 14px;
                                transition: background-color 0.3s;
                                display: block; 
                                width: 100%; 
                                text-align: center;
                                margin-top: 10px; /* Khoảng cách từ nội dung */
                            " onmouseover="this.style.backgroundColor='#0056b3'"
                               onmouseout="this.style.backgroundColor='#007bff'"
                               onclick="window.open('${popupData.url}', '_blank')">
                                Tìm hiểu thêm
                            </button>` : ''}
                    </div>
                </div>
            `;
        }

        marker.bindPopup(popupContent);
    }

    return marker;
}
    // Hàm 2: marker dạng chấm tròn (circleMarker)
    function addCircleMarker(map, lat, lng, options = {}, popupText = null) {
        const defaultOptions = {
            radius: 8,
            color: '#3388ff',
            fillColor: '#3388ff',
            fillOpacity: 0.8
        };
        const mergedOptions = { ...defaultOptions, ...options };
        const marker = L.circleMarker([lat, lng], mergedOptions).addTo(map);
        if (popupText) {
            marker.bindPopup(popupText);
        }
        return marker;
    }

    // Hàm 3: marker SVG/HTML dạng dot (divIcon)
    function addDotMarker(map, lat, lng, color = '#ff0000', size = 16, popupText = null) {
        const html = `
            <div style="
                background:${color};
                width:${size}px;
                height:${size}px;
                border-radius:50%;
                border:2px solid white;
                box-shadow:0 0 4px rgba(0,0,0,0.5);
            "></div>
        `;
        const icon = L.divIcon({
            html,
            className: '',
            iconSize: [size, size],
            iconAnchor: [size / 2, size / 2]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(map);
        if (popupText) {
            marker.bindPopup(popupText);
        }
        return marker;
    }

    // Nếu sau này bạn dùng leaflet.awesome-markers thì thêm ở đây:
    // function addAwesomeMarker(...) { ... }

    // Public API
    return {
        addColoredMarker,
        addCircleMarker,
        addDotMarker
    };
})();
</script>